import { useState, useEffect, useRef } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import './Header.css';

const Header = () => {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  const [dropdownOpen, setDropdownOpen] = useState(false);
  const dropdownRef = useRef(null);

  const handleLogout = () => {
    logout();
    navigate('/login');
  };

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setDropdownOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  return (
    <header className="header">
      <div className="header-content">
        <div className="header-left">
          <Link to="/" className="logo">
            MovieLibrary
          </Link>
          <nav className="nav-links">
            <Link to="/">Home</Link>
            <Link to="/movies">Movies</Link>
            <Link to="/series">Series</Link>
            <Link to="/my-list">My List</Link>
            {user?.role === 'Admin' && <Link to="/admin">Admin</Link>}
          </nav>
        </div>
        <div className="header-right">
          <div className="user-menu" ref={dropdownRef}>
            <button
              className="user-button"
              onClick={() => setDropdownOpen(!dropdownOpen)}
            >
              <span className="user-name">{user?.username}</span>
              <svg
                className={`dropdown-arrow ${dropdownOpen ? 'open' : ''}`}
                width="12"
                height="12"
                viewBox="0 0 12 12"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M2 4L6 8L10 4"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </button>
            {dropdownOpen && (
              <div className="dropdown-menu">
                <button className="dropdown-item" onClick={() => {
                  setDropdownOpen(false);
                  navigate('/settings');
                }}>
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 10C9.10457 10 10 9.10457 10 8C10 6.89543 9.10457 6 8 6C6.89543 6 6 6.89543 6 8C6 9.10457 6.89543 10 8 10Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M12.7333 10C12.6083 10.3021 12.5833 10.6369 12.6621 10.9547C12.7409 11.2725 12.9194 11.5558 13.1733 11.76L13.22 11.8067C13.4267 12.0129 13.5908 12.2568 13.7031 12.5256C13.8154 12.7944 13.8737 13.0829 13.8747 13.3747C13.8757 13.6664 13.8193 13.9553 13.7088 14.2249C13.5983 14.4945 13.4359 14.7395 13.2306 14.9471C13.0254 15.1548 12.7815 15.3207 12.5127 15.4348C12.2439 15.5488 11.9555 15.6089 11.6638 15.6116C11.3721 15.6143 11.0826 15.5595 10.8119 15.4506C10.5412 15.3417 10.2947 15.181 10.0867 14.9775L10.04 14.9308C9.83582 14.677 9.5525 14.4985 9.23467 14.4197C8.91684 14.3409 8.58207 14.3659 8.28 14.4908C7.98274 14.6102 7.73116 14.8178 7.55859 15.0858C7.38602 15.3537 7.30046 15.6698 7.31333 15.99V16.1667C7.31333 16.7855 7.06752 17.379 6.62909 17.8174C6.19067 18.2559 5.59718 18.5017 4.97833 18.5017C4.35949 18.5017 3.766 18.2559 3.32757 17.8174C2.88914 17.379 2.64333 16.7855 2.64333 16.1667V16.08C2.64571 15.7485 2.54892 15.4248 2.36382 15.1518C2.17872 14.8788 1.91401 14.6692 1.60333 14.55C1.30127 14.4251 0.9665 14.4001 0.64867 14.4789C0.33084 14.5577 0.0475173 14.7362 -0.156667 14.99L-0.203333 15.0367C-0.407231 15.2403 -0.651137 15.4009 -0.919919 15.5098C-1.1887 15.6187 -1.47719 15.6736 -1.76889 15.6709C-2.06059 15.6682 -2.34796 15.6081 -2.61676 15.4941C-2.88555 15.3801 -3.12953 15.2142 -3.33477 15.0065C-3.54001 14.7988 -3.70238 14.5538 -3.81286 14.285C-3.92333 14.0162 -3.97947 13.7285 -3.97854 13.4368C-3.9776 13.1451 -3.91958 12.8576 -3.80733 12.5896C-3.69508 12.3216 -3.53099 12.0777 -3.32467 11.8717L-3.278 11.825C-3.02415 11.6208 -2.84564 11.3375 -2.76684 11.0197C-2.68804 10.7019 -2.71303 10.3671 -2.838 10.065C-2.95744 9.76774 -3.16497 9.51616 -3.43295 9.34359C-3.70093 9.17102 -4.01706 9.08546 -4.338 9.09833H-4.51467C-5.13351 9.09833 -5.727 8.85252 -6.16543 8.41409C-6.60386 7.97567 -6.84967 7.38218 -6.84967 6.76333C-6.84967 6.14449 -6.60386 5.551 -6.16543 5.11257C-5.727 4.67414 -5.13351 4.42833 -4.51467 4.42833H-4.428C-4.09651 4.42595 -3.77282 4.32916 -3.49984 4.14406C-3.22686 3.95896 -3.01721 3.69425 -2.898 3.38367C-2.77303 3.08161 -2.74804 2.74684 -2.82684 2.42901C-2.90564 2.11118 -3.08415 1.82786 -3.338 1.57367L-3.38467 1.527C-3.58825 1.32311 -3.74889 1.07921 -3.85782 0.810424C-3.96674 0.541642 -4.02192 0.25315 -4.01918 -0.0385517C-4.01644 -0.33025 -3.95586 -0.617624 -3.84184 -0.886421C-3.72782 -1.15522 -3.56194 -1.3992 -3.35423 -1.60443C-3.14652 -1.80967 -2.9016 -1.97204 -2.63279 -2.08252C-2.36399 -2.19299 -2.07629 -2.24913 -1.78459 -2.2482C-1.49289 -2.24726 -1.20564 -2.18924 -0.937585 -2.07699C-0.669531 -1.96474 -0.425625 -1.80065 -0.219667 -1.59433L-0.173 -1.54767C0.0808397 -1.29382 0.364156 -1.11531 0.681985 -1.03651C0.999814 -0.957708 1.33458 -0.982697 1.63667 -1.10767H1.71333C2.01059 -1.22711 2.26217 -1.43463 2.43474 -1.70262C2.60731 -1.9706 2.69287 -2.28673 2.68 -2.60767V-2.78433C2.68 -3.40318 2.92581 -3.99667 3.36424 -4.4351C3.80267 -4.87352 4.39616 -5.11933 5.015 -5.11933C5.63384 -5.11933 6.22733 -4.87352 6.66576 -4.4351C7.10419 -3.99667 7.35 -3.40318 7.35 -2.78433V-2.69767C7.36287 -2.37673 7.44843 -2.0606 7.621 -1.79262C7.79357 -1.52463 8.04515 -1.31711 8.34242 -1.19767C8.64448 -1.07269 8.97925 -1.04771 9.29708 -1.12651C9.61491 -1.20531 9.89823 -1.38382 10.1524 -1.63767L10.1991 -1.68433C10.405 -1.88792 10.6489 -2.04856 10.9177 -2.15748C11.1865 -2.26641 11.475 -2.32158 11.7667 -2.31884C12.0584 -2.3161 12.3457 -2.25552 12.6145 -2.1415C12.8833 -2.02748 13.1273 -1.8616 13.3325 -1.65389C13.5378 -1.44618 13.7001 -1.20126 13.8106 -0.93245C13.9211 -0.663649 13.9772 -0.37595 13.9763 -0.0842501C13.9753 0.20745 13.9173 0.494702 13.8051 0.762756C13.6928 1.03081 13.5287 1.27471 13.3224 1.48067L13.2757 1.52733C13.0219 1.78148 12.8434 2.06481 12.7646 2.38264C12.6858 2.70047 12.7107 3.03524 12.8357 3.33733V3.414C12.9552 3.71126 13.1627 3.96284 13.4307 4.13541C13.6987 4.30798 14.0148 4.39354 14.3357 4.38067H14.5124C15.1312 4.38067 15.7247 4.62648 16.1631 5.06491C16.6016 5.50333 16.8474 6.09683 16.8474 6.71567C16.8474 7.33451 16.6016 7.928 16.1631 8.36643C15.7247 8.80486 15.1312 9.05067 14.5124 9.05067H14.4257C14.1048 9.06354 13.7887 9.1491 13.5207 9.32167C13.2527 9.49424 13.0452 9.74582 12.9257 10.0431Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  Settings
                </button>
                <button className="dropdown-item logout" onClick={() => {
                  setDropdownOpen(false);
                  handleLogout();
                }}>
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 14H3.33333C2.97971 14 2.64057 13.8595 2.39052 13.6095C2.14048 13.3594 2 13.0203 2 12.6667V3.33333C2 2.97971 2.14048 2.64057 2.39052 2.39052C2.64057 2.14048 2.97971 2 3.33333 2H6" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M10.6667 11.3333L14 8L10.6667 4.66667" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M14 8H6" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  Logout
                </button>
              </div>
            )}
          </div>
        </div>
      </div>
    </header>
  );
};

export default Header;
